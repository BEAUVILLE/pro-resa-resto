<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DIGIY PRO ‚Äî Dashboard</title>

  <!-- Optionnel: ton guard-pro existant -->
  <!-- <script src="./guard-pro.js?v=1"></script> -->

  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#a8b1d1;
      --text:#eef1ff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --accent:#6366f1;
      --line:rgba(255,255,255,.09);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --pad:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 20% -20%, rgba(99,102,241,.25), transparent 70%),
                  radial-gradient(900px 600px at 100% 0%, rgba(34,197,94,.15), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 34px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:10px 6px;margin-bottom:10px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:.2px
    }
    .brand .badge{
      display:inline-flex;align-items:center;justify-content:center;
      width:34px;height:34px;border-radius:11px;
      background:rgba(99,102,241,.18);border:1px solid var(--line)
    }
    .right{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--muted);
      font-weight:600;font-size:13px;
    }
    .pill b{color:var(--text);font-weight:800}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      font-weight:800;cursor:pointer;
    }
    .btn.primary{
      background:rgba(99,102,241,.22);
      border-color:rgba(99,102,241,.35);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:8px;
    }
    @media(min-width:920px){
      .grid{grid-template-columns: 1.05fr .95fr}
    }
    .card{
      background:rgba(18,26,51,.92);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
    }
    .card h3{margin:0 0 8px 0;font-size:15px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .statusDot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .statusDot.ok{background:var(--ok)}
    .statusDot.bad{background:var(--danger)}
    .bigMoney{
      font-size:34px;font-weight:900;letter-spacing:-.8px;margin:6px 0 2px 0
    }
    .mini{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      font-size:13px;color:var(--muted);font-weight:650
    }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .boostBox{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:12px;border-radius:16px;
      background:rgba(99,102,241,.10);
      border:1px solid rgba(99,102,241,.25);
    }
    .boostBox b{display:block;margin-bottom:4px}
    .notifList{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .notif{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px
    }
    .tag{
      font-size:12px;font-weight:900;
      padding:6px 9px;border-radius:999px;border:1px solid var(--line);
      color:var(--muted)
    }
    .tag.warn{color:#ffe2b0;border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10)}
    .tag.ok{color:#c9ffd9;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08)}
    .tag.info{color:#cfd6ff;border-color:rgba(99,102,241,.35);background:rgba(99,102,241,.10)}
    .footer{
      margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end
    }
    .smallLink{color:var(--muted);text-decoration:none;font-weight:750}
    .smallLink:hover{color:var(--text)}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="badge">ü¶Ö</div>
        <div>
          <div id="brandTitle">DIGIY PRO</div>
          <div class="muted" style="font-size:12px;font-weight:700;margin-top:2px" id="brandSub">
            Dashboard ultra simple
          </div>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="pillStatus">Statut : <b>‚Ä¶</b></div>
        <button class="btn" id="btnSettings" type="button">‚öôÔ∏è Param√®tres</button>
      </div>
    </div>

    <div class="grid">

      <!-- CARD A: STATUT -->
      <div class="card" id="cardStatus">
        <h3>Statut & s√©curit√©</h3>

        <div class="row">
          <div class="statusDot" id="dot"></div>
          <div style="flex:1">
            <div style="font-weight:900" id="statusLine">Chargement‚Ä¶</div>
            <div class="muted" style="font-weight:700;font-size:13px;margin-top:2px" id="expiryLine">‚Äî</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="mini" id="metaLine">
          <span>Plan : ‚Äî</span>
          <span>‚Ä¢</span>
          <span>Paiement : ‚Äî</span>
        </div>

        <div class="footer">
          <button class="btn" id="btnManageSub" type="button">G√©rer mon abonnement</button>
        </div>
      </div>

      <!-- CARD B: ARGENT + BOOST -->
      <div class="card" id="cardMoney">
        <h3>Argent</h3>

        <div class="bigMoney" id="moneyMonth">‚Äî FCFA</div>
        <div class="mini" id="moneyMeta">
          <span id="txCount">‚Äî transactions</span>
          <span>‚Ä¢</span>
          <span id="todayHint">‚Äî</span>
        </div>

        <div class="hr"></div>

        <div class="boostBox">
          <div>
            <b>üöÄ BOOST visibilit√©</b>
            <div class="muted" style="font-weight:750;font-size:13px" id="boostText">
              +50% d‚Äôapparition ‚Ä¢ 7 jours ‚Ä¢ 5 000 FCFA
            </div>
            <div class="muted" style="font-weight:750;font-size:12px;margin-top:6px" id="boostStatus">
              Statut boost : ‚Äî
            </div>
          </div>

          <div style="display:flex;flex-direction:column;gap:8px;min-width:160px">
            <button class="btn primary" id="btnBoost" type="button">Activer</button>
            <button class="btn" id="btnBoostInfo" type="button">D√©tails</button>
          </div>
        </div>
      </div>

      <!-- CARD C: ACTION PRINCIPALE -->
      <div class="card" id="cardAction" style="grid-column:1/-1">
        <h3>Action principale</h3>
        <div class="muted" style="font-weight:750;margin-bottom:10px" id="actionDesc">
          Une action. Simple. Efficace.
        </div>

        <div class="row" style="justify-content:space-between">
          <div class="muted" style="font-weight:800" id="actionHint">‚Äî</div>
          <button class="btn primary" id="btnPrimaryAction" type="button">‚Ä¶</button>
        </div>

        <div class="hr"></div>

        <h3>Notifications</h3>
        <div class="notifList" id="notifList">
          <!-- inject -->
        </div>

        <div class="footer">
          <a class="smallLink" href="#" id="linkSupport">Support</a>
          <a class="smallLink" href="#" id="linkPayments">Mes paiements</a>
        </div>
      </div>

    </div>
  </div>

<script>
/**
 * ‚úÖ DIGIY PRO DASH ‚Äî minimal, terrain, universel
 * - Lit ?slug=
 * - R√©sout phone via digiy_subscriptions_public (view)
 * - V√©rifie acc√®s via digiy_has_access(phone,module)
 */

/* =========================
   CONFIG ‚Äî DIGIY MARKET
   ========================= */
const MODULE_CODE = "RESA RESTO";
const MODULE_LABEL = "DIGIY RESA RESTO";
const PRIMARY_ACTION_LABEL = "Publier un produit";
const PRIMARY_ACTION_HINT  = "Ajoute un produit ou g√®re tes commandes.";

/* =========================
   SUPABASE OFFICIEL DIGIY
   ========================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

if(!SUPABASE_URL || !SUPABASE_ANON){
  alert("Configuration Supabase manquante.");
}

/* ====== ROUTES DIGIY ======
   - ABOS: ton GitHub Pages qui propose plans
   - Module home: page principale PRO une fois actif (souvent index du module)
*/
const ABOS_URL = "https://apps.digiylyfe.com/abos/"; // adapte si besoin
const MODULE_HOME_FALLBACK = "/"; // ou "index.html" selon ton module

/* ====== BOOST CONFIG ======
   Ici on propose un BOOST simple.
   Tu peux le g√©rer comme "module add-on" via digiy_build_pay_url + digiy_pay_admin_validate_order
*/
const BOOST = {
  module: "BOOST",
  plan: "boost_7d",
  price_xof: 5000,
  label: "BOOST visibilit√©",
  duration_days: 7
};

/* =========================
   UI HELPERS
   ========================= */
const $ = (id) => document.getElementById(id);

function fmtDateFR(iso){
  if(!iso) return "‚Äî";
  const d = new Date(iso);
  return d.toLocaleDateString("fr-FR", { year:"numeric", month:"long", day:"numeric" });
}

function getSlug(){
  const u = new URL(location.href);
  return u.searchParams.get("slug") || "";
}

function setNotifs(items){
  const box = $("notifList");
  box.innerHTML = "";
  if(!items.length){
    box.innerHTML = `<div class="notif"><div><b>Rien √† signaler</b><div class="muted" style="font-weight:750;margin-top:2px">Tout roule.</div></div><div class="tag ok">OK</div></div>`;
    return;
  }
  for(const it of items){
    const tagClass = it.level === "warn" ? "warn" : it.level === "ok" ? "ok" : "info";
    const div = document.createElement("div");
    div.className = "notif";
    div.innerHTML = `
      <div>
        <b>${it.title}</b>
        <div class="muted" style="font-weight:750;margin-top:2px">${it.text}</div>
      </div>
      <div class="tag ${tagClass}">${it.tag}</div>
    `;
    box.appendChild(div);
  }
}

function daysBetween(aIso, bIso){
  const a = new Date(aIso).getTime();
  const b = new Date(bIso).getTime();
  return Math.ceil((b - a) / (1000*60*60*24));
}

/* =========================
   SUPABASE CALLS (REST)
   ========================= */
async function sbGetSubscriptionBySlug(slug){
  // View minimale: digiy_subscriptions_public (phone,module,slug)
  const url = `${SUPABASE_URL}/rest/v1/digiy_subscriptions_public?select=phone,module,slug&slug=eq.${encodeURIComponent(slug)}&limit=1`;
  const r = await fetch(url, {
    headers: {
      apikey: SUPABASE_ANON,
      authorization: `Bearer ${SUPABASE_ANON}`
    }
  });
  if(!r.ok) throw new Error("Cannot read digiy_subscriptions_public");
  const data = await r.json();
  return data[0] || null;
}

async function sbRpc(name, payload){
  const url = `${SUPABASE_URL}/rest/v1/rpc/${name}`;
  const r = await fetch(url, {
    method:"POST",
    headers: {
      "content-type":"application/json",
      apikey: SUPABASE_ANON,
      authorization: `Bearer ${SUPABASE_ANON}`
    },
    body: JSON.stringify(payload || {})
  });
  if(!r.ok){
    const t = await r.text().catch(()=> "");
    throw new Error(`RPC ${name} failed: ${t || r.status}`);
  }
  return r.json();
}

async function digiyHasAccess(phone, module){
  // ton RPC: digiy_has_access(phone,module) => boolean/json
  const res = await sbRpc("digiy_has_access", { p_phone: phone, p_module: module });
  // adapte selon ton retour (boolean direct ou json)
  if(typeof res === "boolean") return res;
  if(res && typeof res.ok === "boolean") return res.ok;
  if(res && typeof res.has_access === "boolean") return res.has_access;
  return !!res;
}

async function digiyGetSubscriptionFull(phone, module){
  // Si tu as une RPC publique minimaliste (recommand√©) :
  // ex: digiy_get_subscription_status(phone,module) -> {status,plan,expires_at,payment_ref}
  // Sinon tu affiches juste info basique.
  try{
    return await sbRpc("digiy_get_subscription_status", { p_phone: phone, p_module: module });
  }catch(e){
    return null;
  }
}

async function digiyGetDashboardStats(phone, module){
  // Optionnel: une RPC par module ou g√©n√©rique
  // ex: digiy_get_dashboard_stats(p_phone,p_module) -> {month_xof,tx_count,today_hint}
  try{
    return await sbRpc("digiy_get_dashboard_stats", { p_phone: phone, p_module: module });
  }catch(e){
    // fallback
    return { month_xof: null, tx_count: null, today_hint: "Aujourd‚Äôhui" };
  }
}

async function digiyGetBoostStatus(phone){
  // Optionnel: digiy_get_boost_status(p_phone) -> {active,expires_at,views_today}
  try{
    return await sbRpc("digiy_get_boost_status", { p_phone: phone });
  }catch(e){
    return null;
  }
}

async function digiyBuildPayUrl(module, phone, plan){
  // Ton backbone mentionne digiy_build_pay_url(ref)
  // Ici on propose une signature: digiy_build_pay_url(p_module,p_phone,p_plan_code)
  // Adapte si ta RPC attend d'autres param√®tres.
  return await sbRpc("digiy_build_pay_url", { p_module: module, p_phone: phone, p_plan_code: plan });
}

/* =========================
   MAIN
   ========================= */
(async function init(){
  $("brandTitle").textContent = MODULE_LABEL;
  $("btnPrimaryAction").textContent = PRIMARY_ACTION_LABEL;
  $("actionHint").textContent = PRIMARY_ACTION_HINT;
  $("pillStatus").innerHTML = `Statut : <b>‚Ä¶</b>`;

  const slug = getSlug();
  if(!slug){
    $("statusLine").textContent = "Slug manquant";
    $("expiryLine").textContent = "Ajoute ?slug=‚Ä¶";
    $("dot").classList.add("bad");
    $("pillStatus").innerHTML = `Statut : <b>Bloqu√©</b>`;
    setNotifs([{level:"warn",tag:"ACTION",title:"Lien invalide",text:"Le lien doit contenir ?slug=‚Ä¶"}]);
    return;
  }

  // 1) resolve phone
  let subPublic = null;
  try{
    subPublic = await sbGetSubscriptionBySlug(slug);
  }catch(e){
    $("statusLine").textContent = "Erreur connexion";
    $("expiryLine").textContent = "Impossible de v√©rifier le compte.";
    $("dot").classList.add("bad");
    setNotifs([{level:"warn",tag:"R√âSEAU",title:"Connexion",text:"V√©rifie internet ou config Supabase."}]);
    return;
  }

  if(!subPublic || !subPublic.phone){
    $("statusLine").textContent = "Compte introuvable";
    $("expiryLine").textContent = "Ce slug n‚Äôexiste pas.";
    $("dot").classList.add("bad");
    $("pillStatus").innerHTML = `Statut : <b>Inconnu</b>`;
    setNotifs([{level:"warn",tag:"INFO",title:"Slug inconnu",text:"Demande un nouveau lien d‚Äôacc√®s."}]);
    return;
  }

  const phone = subPublic.phone;

  // 2) access check
  const ok = await digiyHasAccess(phone, MODULE_CODE).catch(()=> false);

  if(!ok){
    $("statusLine").textContent = "Abonnement requis";
    $("expiryLine").textContent = "Active ton acc√®s en 1 clic.";
    $("dot").classList.add("bad");
    $("pillStatus").innerHTML = `Statut : <b>Inactif</b>`;

    setNotifs([
      {level:"warn",tag:"ABO",title:"Acc√®s ferm√©",text:"Ton abonnement n‚Äôest pas actif sur ce module."},
    ]);

    $("btnManageSub").onclick = () => {
      location.href = `${ABOS_URL}?module=${encodeURIComponent(MODULE_CODE)}&phone=${encodeURIComponent(phone)}`;
    };

    // On peut m√™me rediriger direct si tu veux:
    // location.href = `${ABOS_URL}?module=${encodeURIComponent(MODULE_CODE)}&phone=${encodeURIComponent(phone)}`;
    return;
  }

  // 3) load status full (optional)
  const status = await digiyGetSubscriptionFull(phone, MODULE_CODE);
  let expiresAt = status?.expires_at || status?.current_period_end || null;
  let plan = status?.plan || "standard";
  let pay = status?.payment_ref ? "valid√©" : "ok";

  $("dot").classList.add("ok");
  $("statusLine").textContent = "Abonnement actif";
  $("expiryLine").textContent = expiresAt ? `Expire le ${fmtDateFR(expiresAt)}` : "Expiration : ‚Äî";
  $("pillStatus").innerHTML = `Statut : <b>Actif</b>`;
  $("metaLine").innerHTML = `<span>Plan : ${plan}</span><span>‚Ä¢</span><span>Paiement : ${pay}</span>`;

  // 4) stats
  const stats = await digiyGetDashboardStats(phone, MODULE_CODE);
  const month = (stats?.month_xof ?? null);
  const tx = (stats?.tx_count ?? null);

  $("moneyMonth").textContent = month ? `${Number(month).toLocaleString("fr-FR")} FCFA` : "‚Äî FCFA";
  $("txCount").textContent = tx ? `${tx} transactions` : "‚Äî transactions";
  $("todayHint").textContent = stats?.today_hint || "Aujourd‚Äôhui";

  // 5) notifs rules
  const notifs = [];
  if(expiresAt){
    const d = daysBetween(new Date().toISOString(), expiresAt);
    if(d <= 3){
      notifs.push({level:"warn",tag:"J-3",title:"Abonnement bient√¥t expir√©",text:`Expire dans ${d} jour(s). Renouvelle pour √©viter coupure.`});
    }else{
      notifs.push({level:"ok",tag:"OK",title:"Abonnement",text:`Actif ‚Äî prochain contr√¥le : J-3.`});
    }
  }

  // 6) boost status
  const boost = await digiyGetBoostStatus(phone);
  if(boost?.active){
    $("boostStatus").textContent = `Statut boost : actif jusqu‚Äôau ${fmtDateFR(boost.expires_at)} ‚Ä¢ +${boost.views_today || 0} vues aujourd‚Äôhui`;
    $("btnBoost").textContent = "Actif";
    $("btnBoost").disabled = true;
    notifs.push({level:"info",tag:"BOOST",title:"Boost actif",text:"Visibilit√© augment√©e. Continue ton activit√©."});
  }else{
    $("boostStatus").textContent = "Statut boost : inactif";
    notifs.push({level:"info",tag:"OPTION",title:"Boost disponible",text:"Active le BOOST si tu veux plus de visibilit√©."});
  }

  setNotifs(notifs);

  // Buttons
  $("btnManageSub").onclick = () => {
    location.href = `${ABOS_URL}?module=${encodeURIComponent(MODULE_CODE)}&phone=${encodeURIComponent(phone)}`;
  };

  $("btnPrimaryAction").onclick = () => {
    // action module sp√©cifique ‚Äî √† adapter
    // exemple: ouvrir la page ‚Äúonline‚Äù / ‚Äúorders‚Äù / ‚Äúnew sale‚Äù
    alert("Action principale ‚Äî branche ici ton flow module.");
  };

  $("btnBoostInfo").onclick = () => {
    alert("BOOST : +50% d‚Äôapparition pendant 7 jours. Paiement direct. Aucun spam.");
  };

  $("btnBoost").onclick = async () => {
    try{
      $("btnBoost").disabled = true;
      $("btnBoost").textContent = "‚Ä¶";

      // Construire l‚ÄôURL de paiement BOOST (via ton syst√®me)
      const pay = await digiyBuildPayUrl(BOOST.module, phone, BOOST.plan);

      // Ton RPC peut renvoyer {url} ou directement une string
      const url = (typeof pay === "string") ? pay : (pay?.url || pay?.pay_url || null);

      if(!url){
        throw new Error("URL paiement BOOST manquante");
      }

      location.href = url; // puis wait.html fera le reste (confirmation / activation)
    }catch(e){
      console.error(e);
      alert("Impossible d‚Äôactiver le BOOST. V√©rifie la config ou la RPC digiy_build_pay_url.");
      $("btnBoost").disabled = false;
      $("btnBoost").textContent = "Activer";
    }
  };

  $("btnSettings").onclick = () => alert("Param√®tres ‚Äî branche ici ton √©cran simple (profil, tel, etc.)");
  $("linkSupport").onclick = (ev) => { ev.preventDefault(); alert("Support ‚Äî branche ton WhatsApp/num√©ro support."); };
  $("linkPayments").onclick = (ev) => { ev.preventDefault(); alert("Mes paiements ‚Äî branche ton √©cran historique."); };

})();
</script>
</body>
</html>
